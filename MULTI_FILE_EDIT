\`\`\`typescript
// lib/real-estate-calculations.ts
import { DEFAULTS, piti, pmt, rateMonthlyFromPercent, safeNumber, solvePriceWithDynamicDownPayment } from "./finance-core"

export interface MortgageCalculation {
  monthlyPayment: number
  totalInterest: number
  totalPayments: number
  principalAndInterest: number
  propertyTax: number
  insurance: number
  pmi?: number
}

export interface AffordabilityAnalysis {
  maxPurchasePrice: number
  maxMonthlyPayment: number
  requiredDownPayment: number
  dtiRatio: number
  remainingBudget: number
  canAfford: boolean
  constraints: string[]
  opportunities: string[]
}

export function calculateMonthlyPayment(loanAmount: number, interestRatePercent: number, loanTermYears: number): number {
  const principal = safeNumber(loanAmount)
  const r = rateMonthlyFromPercent(safeNumber(interestRatePercent))
  const n = safeNumber(loanTermYears) * 12
  return pmt(principal, r, n)
}

export function calculateTotalMonthlyPayment(
  purchasePrice: number,
  downPayment: number,
  interestRatePercent: number,
  loanTermYears: number,
  propertyTaxRatePercent = DEFAULTS.propertyTaxRatePercent,
  annualInsurance = DEFAULTS.annualInsurance,
  monthlyHOA = DEFAULTS.monthlyHOA,
  pmiAnnualRatePercent = DEFAULTS.pmiAnnualRatePercent,
): MortgageCalculation {
  const price = safeNumber(purchasePrice)
  const dpPercent = price > 0 ? (safeNumber(downPayment) / price) * 100 : 0
  const res = piti({
    purchasePrice: price,
    downPaymentPercent: dpPercent,
    interestRatePercent,
    termYears: loanTermYears,
    propertyTaxRatePercent,
    annualInsurance,
    monthlyHOA,
    pmiAnnualRatePercent,
  })

  const totalPayments = res.principalAndInterest * loanTermYears * 12
  const loanAmount = res.loanAmount
  const totalInterest = Math.max(0, totalPayments - loanAmount)

  return {
    monthlyPayment: res.monthly,
    totalInterest,
    totalPayments,
    principalAndInterest: res.principalAndInterest,
    propertyTax: res.propertyTax,
    insurance: res.insurance,
    pmi: res.pmi && res.pmi > 0 ? res.pmi : undefined,
  }
}

export function calculateMaxAffordablePrice(
  annualIncome: number,
  monthlyExpenses: number,
  fixedDebts: number,
  downPaymentSources: number,
  interestRatePercent: number,
  loanTermYears: number,
  propertyTaxRatePercent = DEFAULTS.propertyTaxRatePercent,
  annualInsurance = DEFAULTS.annualInsurance,
  housingRatio = 0.28,
  dtiRatio = 0.43,
  dpCapPercent = 20,
): AffordabilityAnalysis {
  const grossMonthlyIncome = safeNumber(annualIncome) / 12
  const takeHomeIncome = grossMonthlyIncome * 0.7

  const maxPaymentFromHousingRatio = grossMonthlyIncome * safeNumber(housingRatio)
  const maxPaymentFromDTI = grossMonthlyIncome * safeNumber(dtiRatio) - safeNumber(fixedDebts)
  const availableBudget = takeHomeIncome - safeNumber(monthlyExpenses) - safeNumber(fixedDebts)

  const maxMonthlyPayment = Math.max(0, Math.min(maxPaymentFromHousingRatio, Math.min(maxPaymentFromDTI, availableBudget)))

  // Solve for price with dynamic down payment capped at dpCapPercent
  const maxPrice = solvePriceWithDynamicDownPayment({
    targetMonthly: maxMonthlyPayment,
    availableDownPayment: safeNumber(downPaymentSources),
    dpCapPercent,
    interestRatePercent,
    termYears: loanTermYears,
    propertyTaxRatePercent,
    annualInsurance,
  })

  const dpUsed = Math.min(safeNumber(downPaymentSources), maxPrice * (dpCapPercent / 100))
  const comp = piti({
    purchasePrice: maxPrice,
    downPaymentPercent: maxPrice > 0 ? (dpUsed / maxPrice) * 100 : 0,
    interestRatePercent,
    termYears: loanTermYears,
    propertyTaxRatePercent,
    annualInsurance,
  })

  const finalMonthly = comp.monthly
  const dti = grossMonthlyIncome > 0 ? ((safeNumber(fixedDebts) + finalMonthly) / grossMonthlyIncome) * 100 : 1000
  const remainingBudget = takeHomeIncome - finalMonthly - safeNumber(monthlyExpenses) - safeNumber(fixedDebts)

  const constraints: string[] = []
  const opportunities: string[] = []

  if (maxPrice <= 0) constraints.push("Current expenses exceed income - reduce expenses to afford a home")
  if (dti > 40) constraints.push(`High DTI ratio: ${dti.toFixed(1)}% (lenders prefer <43%)`)
  if (remainingBudget < 500) constraints.push("Tight budget - consider increasing income or reducing expenses")
  if (safeNumber(downPaymentSources) < maxPrice * (dpCapPercent / 100)) {
    const gap = maxPrice * (dpCapPercent / 100) - safeNumber(downPaymentSources)
    if (gap > 0) constraints.push(`Need ${(gap / 1000).toFixed(0)}k more for down payment`)
  }

  if (remainingBudget > 1000) {
    opportunities.push(`Strong budget position - could afford ${(((remainingBudget * 200) / 1000) | 0)}k more house`)
  }
  if (safeNumber(downPaymentSources) > maxPrice * (dpCapPercent / 100) * 1.1) {
    opportunities.push("Excess down payment available - consider higher price range or lower monthly payment")
  }

  return {
    maxPurchasePrice: Math.max(0, maxPrice),
    maxMonthlyPayment,
    requiredDownPayment: Math.max(0, maxPrice * (dpCapPercent / 100)),
    dtiRatio: dti,
    remainingBudget,
    canAfford: maxPrice > 0 && remainingBudget >= 0,
    constraints,
    opportunities,
  }
}

// Wrapper expected by RealEstatePlannerPage (keeps existing import intact)
export function calculateAffordability(input: {
  annualIncome: number
  monthlyExpenses: number
  fixedDebts: number
  downPaymentSources: number
  interestRate: number // percent
  loanTerm: number // years
  housingPercentage: number // percent of take-home
}) {
  const res = calculateMaxAffordablePrice(
    input.annualIncome,
    input.monthlyExpenses,
    input.fixedDebts,
    input.downPaymentSources,
    input.interestRate,
    input.loanTerm,
    DEFAULTS.propertyTaxRatePercent,
    DEFAULTS.annualInsurance,
    Math.max(0, Math.min(1, (input.housingPercentage || 30) / 100)),
    0.43,
    20,
  )
  return res
}

export function formatCurrency(amount: number): string {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(safeNumber(amount))
}

export function formatPercentage(decimal: number): string {
  return `${(safeNumber(decimal) * 100).toFixed(1)}%`
}
\`\`\`

\`\`\`typescript
// lib/affordability-calculations.ts
import { piti, pmt, rateMonthlyFromPercent, safeNumber, DEFAULTS } from "./finance-core"
import type { Property, Scenario, PropertyAffordability } from "./property-types"

export const formatCurrency = (amount: number): string => {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(safeNumber(amount))
}

export const calculatePropertyAffordability = (property: Property, scenario: Scenario): PropertyAffordability => {
  const { financialInputs } = scenario

  const grossMonthlyIncome = safeNumber(financialInputs.annualIncome) / 12
  const takeHomeIncome = grossMonthlyIncome * 0.7

  const maxMonthlyPayment = grossMonthlyIncome * 0.28

  // Use finance-core PITI to ensure consistent math and handle 0% rate
  const downPaymentAmount = property.price * 0.2
  const dpPercent = (downPaymentAmount / property.price) * 100
  const calc = piti({
    purchasePrice: property.price,
    downPaymentPercent: dpPercent,
    interestRatePercent: safeNumber(financialInputs.interestRate),
    termYears: safeNumber(financialInputs.loanTerm),
    propertyTaxRatePercent: (safeNumber(property.propertyTaxRate) || 0) * 100, // property rate given as decimal
    annualInsurance: DEFAULTS.annualInsurance,
    monthlyHOA: safeNumber((property as any).monthlyHOA) || 0,
  })

  const totalMonthlyPayment = calc.monthly
  const monthlyPrincipalInterest = calc.principalAndInterest
  const monthlyPropertyTax = calc.propertyTax
  const monthlyInsurance = calc.insurance
  const monthlyHOA = calc.hoa

  const totalMonthlyDebts = safeNumber(financialInputs.fixedDebts) + totalMonthlyPayment
  const dtiRatio = grossMonthlyIncome > 0 ? (totalMonthlyDebts / grossMonthlyIncome) * 100 : 1000

  const remainingBudget =
    takeHomeIncome -
    totalMonthlyPayment -
    safeNumber(financialInputs.monthlyExpenses) -
    safeNumber(financialInputs.fixedDebts)

  const canAfford =
    totalMonthlyPayment <= maxMonthlyPayment &&
    dtiRatio <= 43 &&
    safeNumber(financialInputs.downPaymentSources) >= downPaymentAmount &&
    remainingBudget >= 0

  const paymentScore = Math.max(0, 100 - (totalMonthlyPayment / Math.max(1, maxMonthlyPayment)) * 100)
  const dtiScore = Math.max(0, 100 - (dtiRatio / 43) * 100)
  const downPaymentScore = Math.min(
    100,
    (safeNumber(financialInputs.downPaymentSources) / Math.max(1, downPaymentAmount)) * 100,
  )
  const budgetScore = Math.max(0, Math.min(100, (remainingBudget / 1000) * 100))

  const affordabilityScore = (paymentScore + dtiScore + downPaymentScore + budgetScore) / 4

  const recommendations: string[] = []
  const constraints: string[] = []

  if (!canAfford) {
    if (totalMonthlyPayment > maxMonthlyPayment) {
      constraints.push(
        `Monthly payment ${formatCurrency(totalMonthlyPayment)} exceeds recommended ${formatCurrency(maxMonthlyPayment)}`,
      )
    }
    if (dtiRatio > 43) {
      constraints.push(`DTI ratio ${dtiRatio.toFixed(1)}% exceeds 43% limit`)
    }
    if (safeNumber(financialInputs.downPaymentSources) < downPaymentAmount) {
      constraints.push(
        `Need ${formatCurrency(Math.max(0, downPaymentAmount - safeNumber(financialInputs.downPaymentSources)))} more for down payment`,
      )
    }
    if (remainingBudget < 0) {
      constraints.push(`Budget shortfall of ${formatCurrency(Math.abs(remainingBudget))} per month`)
    }
  } else {
    if (remainingBudget > 1000) {
      recommendations.push(`Strong budget position with ${formatCurrency(remainingBudget)} monthly cushion`)
    }
    if (dtiRatio < 30) {
      recommendations.push(`Excellent DTI ratio of ${dtiRatio.toFixed(1)}%`)
    }
  }

  return {
    canAfford,
    affordabilityScore,
    monthlyPayment: totalMonthlyPayment,
    downPaymentNeeded: downPaymentAmount,
    remainingBudget,
    dtiRatio,
    recommendations,
    constraints,
  }
}
\`\`\`

\`\`\`typescript
// components/property-workbench/affordability-summary.tsx
import { Scenario } from "@/lib/property-types"
import { formatCurrency } from "@/lib/affordability-calculations"
import { useScenario } from "@/hooks/use-scenario"
import { useMemo } from "react"
import { useDebounce } from "@/hooks/use-debounce"
import { Skeleton } from "@/components/ui/skeleton"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Progress } from "@/components/ui/progress"
import { cn } from "@/lib/utils"
import { Info } from 'lucide-react'
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip"
import { useSettings } from "@/hooks/use-settings"
import { Slider } from "@/components/ui/slider"
import { Label } from "@/components/ui/label"
import { Switch } from "@/components/ui/switch"
import { Button } from "@/components/ui/button"
import {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
import { DEFAULTS, piti, solvePurchasePriceForMonthlyBudget, safeNumber } from "@/lib/finance-core"

interface AffordabilityCalculation {
  maxPurchasePrice: number
  maxMonthlyPayment: number
  actualMonthlyPayment: number
  availableDownPayment: number
  requiredDownPayment: number
  maxPriceFromDownPayment: number
  loanAmount: number
  dtiRatio: number
  monthlyIncome: number
  takeHomeIncome: number
  remainingBudget: number
  constraints: string[]
  opportunities: string[]
  housingPercentage: number
  downPaymentPercentage: number
  monthlyPrincipalInterest: number
  monthlyPropertyTax: number
  monthlyInsurance: number
  downPaymentStatus: "on-target" | "excess" | "shortfall"
  excessAmount?: number
  shortfallAmount?: number
}

interface AffordabilitySummaryProps {
  className?: string
}

export function AffordabilitySummary({ className }: AffordabilitySummaryProps) {
  const { scenario, updateScenario } = useScenario()
  const { settings, updateSettings } = useSettings()

  const debouncedScenario = useDebounce(scenario, 500)

  const housingPercentage = settings.housingPercentage
  const downPaymentPercentage = settings.downPaymentPercentage

  const affordability = useMemo(() => {
    if (!debouncedScenario) return null
    return calculateMaxAffordability(debouncedScenario, housingPercentage, downPaymentPercentage)
  }, [debouncedScenario, housingPercentage, downPaymentPercentage])

  if (!scenario) {
    return (
      <Card className={cn("col-span-2", className)}>
        <CardHeader>
          <CardTitle>Affordability</CardTitle>
        </CardHeader>
        <CardContent className="grid gap-4">
          <Skeleton className="h-4 w-[250px]" />
          <Skeleton className="h-4 w-[200px]" />
          <Skeleton className="h-4 w-[150px]" />
        </CardContent>
      </Card>
    )
  }

  const calculateMaxAffordability = (
    scenario: Scenario,
    housingPercentage: number,
    downPaymentPercentage: number,
  ): AffordabilityCalculation => {
    const { financialInputs } = scenario

    // Income
    const grossAnnualIncome = safeNumber(financialInputs.annualIncome) + safeNumber(financialInputs.futureIncomeMonthly || 0) * 12
    const grossMonthlyIncome = grossAnnualIncome / 12
    const takeHomeIncome = grossMonthlyIncome * 0.7

    // Expenses: enforce policy - future expenses do NOT affect price/payment; they are only used in budget breakdown
    const totalMonthlyExpenses = safeNumber(financialInputs.monthlyExpenses)
    const futureExpensesMonthly = safeNumber(financialInputs.futureExpensesMonthly || 0)
    const fixedDebts = safeNumber(financialInputs.fixedDebts)

    // Max monthly payment (conservative)
    const maxDTI = 0.43
    const maxTotalDebtPayment = grossMonthlyIncome * maxDTI
    const maxHousingPaymentFromDTI = maxTotalDebtPayment - fixedDebts

    const maxLivabilityPayment = (takeHomeIncome * safeNumber(housingPercentage)) / 100
    const availableForHousing = takeHomeIncome - totalMonthlyExpenses - fixedDebts

    const maxMonthlyPayment = Math.max(
      0,
      Math.min(maxHousingPaymentFromDTI, Math.min(maxLivabilityPayment, availableForHousing)),
    )

    // Solve ideal house price for fixed down payment percent
    const interestRatePercent = safeNumber(financialInputs.interestRate ?? 6.85)
    const termYears = safeNumber(financialInputs.loanTerm ?? 30)

    const idealHousePrice = solvePurchasePriceForMonthlyBudget({
      targetMonthly: maxMonthlyPayment,
      downPaymentPercent: safeNumber(downPaymentPercentage),
      interestRatePercent,
      termYears,
      propertyTaxRatePercent: DEFAULTS.propertyTaxRatePercent,
      annualInsurance: DEFAULTS.annualInsurance,
    })

    const requiredDownPayment = (idealHousePrice * downPaymentPercentage) / 100
    const availableDownPayment = safeNumber(financialInputs.downPaymentSources)

    let downPaymentStatus: "on-target" | "excess" | "shortfall"
    let excessAmount: number | undefined
    let shortfallAmount: number | undefined

    const tolerance = requiredDownPayment * 0.05
    if (availableDownPayment < requiredDownPayment - tolerance) {
      downPaymentStatus = "shortfall"
      shortfallAmount = requiredDownPayment - availableDownPayment
    } else if (availableDownPayment > requiredDownPayment + tolerance) {
      downPaymentStatus = "excess"
      excessAmount = availableDownPayment - requiredDownPayment
    } else {
      downPaymentStatus = "on-target"
    }

    // Apply strategy and compute actual monthly payment
    const strategy = financialInputs.excessDownPaymentStrategy || "save"
    let finalMaxPurchasePrice = idealHousePrice
    let actualDownPaymentUsed = requiredDownPayment
    let actualMonthlyPayment = maxMonthlyPayment

    const computeMonthlyFor = (price: number, dpUsed: number) => {
      const dpPct = price > 0 ? (dpUsed / price) * 100 : 0
      const comp = piti({
        purchasePrice: price,
        downPaymentPercent: dpPct,
        interestRatePercent,
        termYears,
        propertyTaxRatePercent: DEFAULTS.propertyTaxRatePercent,
        annualInsurance: DEFAULTS.annualInsurance,
      })
      return comp.monthly
    }

    if (downPaymentStatus === "shortfall") {
      finalMaxPurchasePrice = availableDownPayment / (downPaymentPercentage / 100)
      actualDownPaymentUsed = availableDownPayment
      actualMonthlyPayment = computeMonthlyFor(finalMaxPurchasePrice, actualDownPaymentUsed)
    } else if (downPaymentStatus === "excess") {
      if (strategy === "increase-price") {
        finalMaxPurchasePrice = idealHousePrice + (excessAmount || 0)
        actualDownPaymentUsed = availableDownPayment
        actualMonthlyPayment = computeMonthlyFor(finalMaxPurchasePrice, actualDownPaymentUsed)
      } else if (strategy === "reduce-payment") {
        finalMaxPurchasePrice = idealHousePrice
        actualDownPaymentUsed = availableDownPayment
        actualMonthlyPayment = computeMonthlyFor(finalMaxPurchasePrice, actualDownPaymentUsed)
      } else {
        finalMaxPurchasePrice = idealHousePrice
        actualDownPaymentUsed = requiredDownPayment
        actualMonthlyPayment = maxMonthlyPayment
      }
    } else {
      finalMaxPurchasePrice = idealHousePrice
      actualDownPaymentUsed = requiredDownPayment
      actualMonthlyPayment = maxMonthlyPayment
    }

    // Components at final price
    const finalDpPct = finalMaxPurchasePrice > 0 ? (actualDownPaymentUsed / finalMaxPurchasePrice) * 100 : 0
    const components = piti({
      purchasePrice: finalMaxPurchasePrice,
      downPaymentPercent: finalDpPct,
      interestRatePercent,
      termYears,
      propertyTaxRatePercent: DEFAULTS.propertyTaxRatePercent,
      annualInsurance: DEFAULTS.annualInsurance,
    })

    const dtiRatio = grossMonthlyIncome > 0 ? ((actualMonthlyPayment + fixedDebts) / grossMonthlyIncome) * 100 : 1000
    const remainingBudget = takeHomeIncome - actualMonthlyPayment - totalMonthlyExpenses - fixedDebts - futureExpensesMonthly

    const constraints: string[] = []
    const opportunities: string[] = []

    if (downPaymentStatus === "shortfall") {
      constraints.push(
        `Need ${formatCurrency(shortfallAmount!)} more down payment to afford your ideal ${formatCurrency(idealHousePrice)} house`,
      )
    }
    if (maxMonthlyPayment <= 0) {
      constraints.push("Current expenses exceed income - reduce expenses to afford a home")
    }
    if (dtiRatio > 40) {
      constraints.push(`High DTI ratio: ${dtiRatio.toFixed(1)}% (banks prefer <43%)`)
    }
    if (remainingBudget < 500) {
      constraints.push("Tight budget - consider reducing target payment or increasing income")
    }
    if (remainingBudget > 1000) {
      opportunities.push(`Strong budget position - could afford ${formatCurrency(remainingBudget * 200)} more house`)
    }
    if (downPaymentStatus === "excess" && strategy === "save") {
      opportunities.push(
        `Consider using your ${formatCurrency(excessAmount!)} excess down payment to buy a more expensive house or reduce monthly payments`,
      )
    }

    return {
      maxPurchasePrice: Math.max(0, finalMaxPurchasePrice),
      maxMonthlyPayment: Math.max(0, maxMonthlyPayment),
      actualMonthlyPayment: Math.max(0, actualMonthlyPayment),
      availableDownPayment,
      requiredDownPayment: Math.max(0, requiredDownPayment),
      maxPriceFromDownPayment: availableDownPayment / Math.max(0.0001, downPaymentPercentage / 100),
      loanAmount: Math.max(0, finalMaxPurchasePrice - actualDownPaymentUsed),
      dtiRatio,
      monthlyIncome: grossMonthlyIncome,
      takeHomeIncome,
      remainingBudget,
      constraints,
      opportunities,
      housingPercentage,
      downPaymentPercentage,
      monthlyPrincipalInterest: Math.max(0, components.principalAndInterest),
      monthlyPropertyTax: Math.max(0, components.propertyTax),
      monthlyInsurance: Math.max(0, components.insurance),
      downPaymentStatus,
      excessAmount,
      shortfallAmount,
    }
  }

  return (
    <Card className={cn("col-span-2", className)}>
      <CardHeader>
        <CardTitle>Affordability</CardTitle>
      </CardHeader>
      <CardContent className="grid gap-4">
        <div className="grid gap-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <h3 className="text-lg font-semibold">Max Purchase Price</h3>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="ml-2 h-4 w-4 text-muted-foreground" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      This is the maximum price you can afford based on your income, expenses, and down payment. It assumes
                      a {settings.downPaymentPercentage}% down payment and a housing expense of {settings.housingPercentage}%
                      of your take-home pay.
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            <Badge variant="secondary">{formatCurrency(affordability?.maxPurchasePrice || 0)}</Badge>
          </div>
          <Progress value={(affordability?.maxPurchasePrice || 0) / 10000} max={100} />
        </div>

        <div className="grid gap-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <h3 className="text-lg font-semibold">Max Monthly Payment</h3>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="ml-2 h-4 w-4 text-muted-foreground" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      This is the maximum monthly payment you can afford based on your income, expenses, and debts. It assumes
                      a housing expense of {settings.housingPercentage}% of your take-home pay.
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            <Badge variant="secondary">{formatCurrency(affordability?.maxMonthlyPayment || 0)}</Badge>
          </div>
          <Progress value={(affordability?.maxMonthlyPayment || 0) / 1000} max={100} />
        </div>

        <div className="border rounded-md p-4 bg-secondary">
          <h4 className="mb-2 font-semibold">Purchase Power</h4>
          <div className="text-sm text-muted-foreground">
            Based on your max monthly payment, you could afford a home up to:
            <div className="mt-2 text-lg font-bold">
              {formatCurrency(
                (() => {
                  const maxPayment = affordability.maxMonthlyPayment
                  const interestRate = scenario.financialInputs.interestRate ?? 6.85
                  const numYears = scenario.financialInputs.loanTerm ?? 30
                  const price = solvePurchasePriceForMonthlyBudget({
                    targetMonthly: maxPayment,
                    downPaymentPercent: downPaymentPercentage,
                    interestRatePercent: interestRate,
                    termYears: numYears,
                    propertyTaxRatePercent: DEFAULTS.propertyTaxRatePercent,
                    annualInsurance: DEFAULTS.annualInsurance,
                  })
                  return Math.max(0, price)
                })(),
              )}
            </div>
          </div>
        </div>

        <div className="grid gap-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <h3 className="text-lg font-semibold">Remaining Budget</h3>
            </div>
            <Badge variant="secondary">{formatCurrency(affordability?.remainingBudget || 0)}</Badge>
          </div>
          <Progress value={(affordability?.remainingBudget || 0) / 1000} max={100} />
        </div>

        <div className="grid gap-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <h3 className="text-lg font-semibold">DTI Ratio</h3>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="ml-2 h-4 w-4 text-muted-foreground" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      This is your Debt-to-Income ratio. It is calculated by dividing your total monthly debts by your gross
                      monthly income. Lenders prefer a DTI ratio of less than 43%.
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            <Badge variant="secondary">{(affordability?.dtiRatio || 0).toFixed(1)}%</Badge>
          </div>
          <Progress value={(affordability?.dtiRatio || 0)} max={100} />
        </div>

        <div className="grid gap-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <h3 className="text-lg font-semibold">Down Payment</h3>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="ml-2 h-4 w-4 text-muted-foreground" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      This is the amount of down payment you have available. It is compared to the required down payment for
                      your ideal house price.
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            <Badge variant="secondary">{formatCurrency(affordability?.availableDownPayment || 0)}</Badge>
          </div>
          <Progress value={(affordability?.availableDownPayment || 0) / 10000} max={100} />
        </div>

        <div className="grid gap-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <h3 className="text-lg font-semibold">Housing Percentage</h3>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="ml-2 h-4 w-4 text-muted-foreground" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      This is the percentage of your take-home pay that you are willing to spend on housing. It is used to
                      calculate your max monthly payment.
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            <Badge variant="secondary">{(settings.housingPercentage || 0).toFixed(1)}%</Badge>
          </div>
          <div className="flex items-center justify-between">
            <Label htmlFor="housing-percentage">Adjust Housing %:</Label>
            <div className="w-24">
              <Slider
                id="housing-percentage"
                defaultValue={[settings.housingPercentage]}
                max={50}
                step={1}
                onValueChange={(value) => updateSettings({ housingPercentage: value[0] })}
              />
            </div>
          </div>
        </div>

        <div className="grid gap-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <h3 className="text-lg font-semibold">Down Payment Percentage</h3>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="ml-2 h-4 w-4 text-muted-foreground" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      This is the percentage of the home price that you are willing to put down as a down payment. It is used
                      to calculate your required down payment.
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            <Badge variant="secondary">{(settings.downPaymentPercentage || 0).toFixed(1)}%</Badge>
          </div>
          <div className="flex items-center justify-between">
            <Label htmlFor="down-payment-percentage">Adjust Down Payment %:</Label>
            <div className="w-24">
              <Slider
                id="down-payment-percentage"
                defaultValue={[settings.downPaymentPercentage]}
                max={50}
                step={1}
                onValueChange={(value) => updateSettings({ downPaymentPercentage: value[0] })}
              />
            </div>
          </div>
        </div>

        <div className="grid gap-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <h3 className="text-lg font-semibold">Excess Down Payment Strategy</h3>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="ml-2 h-4 w-4 text-muted-foreground" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      This is the strategy that will be used if you have excess down payment available. You can choose to
                      increase the price of the home you can afford, or reduce your monthly payments.
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
          </div>
          <div className="flex items-center justify-between">
            <Label htmlFor="increase-price">Increase Price</Label>
            <Switch
              id="increase-price"
              checked={scenario.financialInputs.excessDownPaymentStrategy === "increase-price"}
              onCheckedChange={(checked) =>
                updateScenario({
                  financialInputs: {
                    ...scenario.financialInputs,
                    excessDownPaymentStrategy: checked ? "increase-price" : "save",
                  },
                })
              }
            />
          </div>
        </div>

        <div className="grid gap-2">
          <h3 className="text-lg font-semibold">Constraints</h3>
          {affordability?.constraints.length === 0 ? (
            <div className="text-sm text-muted-foreground">No constraints found.</div>
          ) : (
            <ul className="list-disc pl-4">
              {affordability?.constraints.map((constraint, i) => (
                <li key={i} className="text-sm text-muted-foreground">
                  {constraint}
                </li>
              ))}
            </ul>
          )}
        </div>

        <div className="grid gap-2">
          <h3 className="text-lg font-semibold">Opportunities</h3>
          {affordability?.opportunities.length === 0 ? (
            <div className="text-sm text-muted-foreground">No opportunities found.</div>
          ) : (
            <ul className="list-disc pl-4">
              {affordability?.opportunities.map((opportunity, i) => (
                <li key={i} className="text-sm text-muted-foreground">
                  {opportunity}
                </li>
              ))}
            </ul>
          )}
        </div>

        <Dialog>
          <DialogTrigger asChild>
            <Button variant="outline">How is this calculated?</Button>
          </DialogTrigger>
          <DialogContent className="sm:max-w-[425px]">
            <DialogHeader>
              <DialogTitle>Affordability Calculation</DialogTitle>
              <DialogDescription>
                Here's a breakdown of how we calculate your affordability.
              </DialogDescription>
            </DialogHeader>
            <div className="grid gap-4 py-4">
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="email" className="text-right">
                  Annual Income
                </Label>
                <div className="col-span-3 font-bold">{formatCurrency(scenario.financialInputs.annualIncome)}</div>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="name" className="text-right">
                  Monthly Expenses
                </Label>
                <div className="col-span-3 font-bold">{formatCurrency(scenario.financialInputs.monthlyExpenses)}</div>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="username" className="text-right">
                  Fixed Debts
                </Label>
                <div className="col-span-3 font-bold">{formatCurrency(scenario.financialInputs.fixedDebts)}</div>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="username" className="text-right">
                  Down Payment
                </Label>
                <div className="col-span-3 font-bold">{formatCurrency(scenario.financialInputs.downPaymentSources)}</div>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="username" className="text-right">
                  Interest Rate
                </Label>
                <div className="col-span-3 font-bold">{(scenario.financialInputs.interestRate || 0).toFixed(1)}%</div>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="username" className="text-right">
                  Loan Term
                </Label>
                <div className="col-span-3 font-bold">{scenario.financialInputs.loanTerm} years</div>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="username" className="text-right">
                  Housing Percentage
                </Label>
                <div className="col-span-3 font-bold">{(settings.housingPercentage || 0).toFixed(1)}%</div>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="username" className="text-right">
                  Down Payment Percentage
                </Label>
                <div className="col-span-3 font-bold">{(settings.downPaymentPercentage || 0).toFixed(1)}%</div>
              </div>
            </div>
            <DialogFooter>
              <DialogClose asChild>
                <Button type="button">Close</Button>
              </DialogClose>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </CardContent>
    </Card>
  )
}
\`\`\`

\`\`\`typescript
// hooks/use-memoized-calculations.ts
import { useMemo } from "react"
import { Scenario } from "@/lib/property-types"
import { calculatePropertyAffordability } from "@/lib/affordability-calculations"
import { DEFAULTS, safeNumber } from "@/lib/finance-core"

interface UseMemoizedCalculationsProps {
  scenario: Scenario | null
  propertyTaxRate?: number
  homeownersInsuranceAnnual?: number
}

export const useMemoizedCalculations = ({
  scenario,
  propertyTaxRate,
  homeownersInsuranceAnnual,
}: UseMemoizedCalculationsProps) => {
  const getInterestRate = (rateValue: any): number => {
    const parsed = typeof rateValue === "string" ? Number.parseFloat(rateValue) : Number(rateValue)
    const pct = Number.isFinite(parsed) ? parsed : 6.85
    // Clamp to a reasonable range of APR percentages
    return Math.max(0, Math.min(20, pct))
  }

  const selectedMortgageOptions = useMemo(() => {
    if (!scenario) {
      return {
        interestRate: 6.85,
        loanTerm: 30,
        propertyTaxRate: DEFAULTS.propertyTaxRatePercent,
        homeownersInsuranceAnnual: DEFAULTS.annualInsurance,
      }
    }

    const interestRate = getInterestRate(scenario.financialInputs.interestRate)
    const loanTerm = Number(scenario.financialInputs.loanTerm) || 30

    return {
      interestRate,
      loanTerm,
      propertyTaxRate: DEFAULTS.propertyTaxRatePercent,
      homeownersInsuranceAnnual: DEFAULTS.annualInsurance,
    }
  }, [scenario])

  const propertyAffordability = useMemo(() => {
    if (!scenario || !scenario.selectedProperty) {
      return null
    }

    return calculatePropertyAffordability(scenario.selectedProperty, scenario)
  }, [scenario])

  return {
    selectedMortgageOptions,
    propertyAffordability,
  }
}
\`\`\`
